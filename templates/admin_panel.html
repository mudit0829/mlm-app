<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Panel - TRADEERA</title>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    /* (kept your styling; unchanged) */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Nunito', sans-serif; background: #f8fafc; color: #1f2937; }
    .navbar { background: linear-gradient(135deg,#2563eb 0%,#1e40af 100%); color: white; padding:1rem 2rem; display:flex; justify-content:space-between; align-items:center; box-shadow:0 4px 12px rgba(37,99,235,0.15);}
    .navbar-brand{font-size:1.5rem;font-weight:900;letter-spacing:-0.5px;}
    .navbar-right{display:flex;gap:2rem;align-items:center;}
    .user-info{background:rgba(255,255,255,0.1);padding:0.5rem 1rem;border-radius:8px;font-weight:600;}
    .logout-btn{background:#dc2626;border:none;color:white;padding:0.6rem 1.5rem;border-radius:6px;cursor:pointer;font-weight:700;font-size:0.95rem;transition:all 0.3s ease;}
    .logout-btn:hover{background:#b91c1c;transform:scale(1.05);} .logout-btn:active{transform:scale(0.95);}
    .container{max-width:1600px;margin:2rem auto;padding:0 1rem;}
    .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:2rem;flex-wrap:wrap;gap:1rem;}
    .header h1{font-size:2rem;color:#0f172a;}
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:1.5rem;margin-bottom:2rem;}
    .stat-card{background:white;padding:1.5rem;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.05);border-left:4px solid #2563eb;}
    .stat-card h3{color:#64748b;font-size:0.9rem;margin-bottom:0.5rem;font-weight:600;}
    .stat-card .value{font-size:2rem;font-weight:900;color:#2563eb;}
    .table-container{background:white;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.05);overflow:hidden;}
    .table-header{background:#f1f5f9;padding:1.5rem;border-bottom:1px solid #e2e8f0;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:1rem;}
    .table-header h2{font-size:1.3rem;color:#0f172a;}
    .search-box input{padding:0.75rem 1rem;border:1.5px solid #e2e8f0;border-radius:8px;font-family:'Nunito',sans-serif;font-size:0.95rem;width:250px;}
    .search-box input:focus{outline:none;border-color:#2563eb;box-shadow:0 0 0 3px rgba(37,99,235,0.1);}
    .table-wrapper{overflow-x:auto;}
    table{width:100%;border-collapse:collapse;}
    th{background:#f8fafc;padding:1rem;text-align:left;font-weight:700;color:#475569;border-bottom:2px solid #e2e8f0;font-size:0.9rem;white-space:nowrap;}
    td{padding:1rem;border-bottom:1px solid #e2e8f0;white-space:nowrap;}
    tr:hover{background:#f9fafb;}
    .status-badge{display:inline-block;padding:0.4rem 0.8rem;border-radius:6px;font-size:0.85rem;font-weight:600;}
    .status-active{background:#d1fae5;color:#065f46;} .status-inactive{background:#fee2e2;color:#991b1b;}
    .user-id{font-size:0.8rem;color:#64748b;font-family:'Courier New',monospace;max-width:150px;overflow:hidden;text-overflow:ellipsis;}
    .amount{font-weight:700;color:#2563eb;}
    .actions{display:flex;gap:0.5rem;flex-wrap:wrap;}
    .btn{padding:0.5rem 0.8rem;border:none;border-radius:6px;cursor:pointer;font-weight:600;font-size:0.85rem;transition:all 0.3s;white-space:nowrap;}
    .btn-activate-100{background:#3b82f6;color:white;} .btn-activate-100:hover{background:#2563eb;}
    .btn-activate-free{background:#10b981;color:white;} .btn-activate-free:hover{background:#059669;}
    .btn-view{background:#6b7280;color:white;} .btn-view:hover{background:#4b5563;}
    .btn-copy{background:#8b5cf6;color:white;padding:0.3rem 0.6rem;font-size:0.75rem;} .btn-copy:hover{background:#7c3aed;}
    .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);align-items:center;justify-content:center;z-index:1000;}
    .modal.active{display:flex;}
    .modal-content{background:white;padding:2rem;border-radius:12px;max-width:600px;width:90%;max-height:90vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,0.3);}
    .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem;}
    .modal-header h2{font-size:1.5rem;color:#0f172a;}
    .close-btn{background:none;border:none;font-size:1.5rem;cursor:pointer;color:#64748b;}
    .user-detail{margin-bottom:1rem;padding-bottom:1rem;border-bottom:1px solid #e2e8f0;}
    .user-detail label{color:#64748b;font-weight:600;font-size:0.9rem;}
    .user-detail p{color:#1f2937;margin-top:0.3rem;font-size:0.95rem;word-break:break-all;}
    .loading{display:none;text-align:center;padding:2rem;color:#2563eb;}
    .spinner{border:3px solid #e2e8f0;border-top-color:#2563eb;border-radius:50%;width:30px;height:30px;animation:spin 0.8s linear infinite;margin:0 auto 1rem;}
    @keyframes spin{to{transform:rotate(360deg);}}
    .empty-state{text-align:center;padding:3rem;color:#94a3b8;}
    .empty-state i{font-size:3rem;margin-bottom:1rem;opacity:0.5;}

    .info-banner{display:none;background:#fff7ed;border:1px solid #ffd8a8;color:#92400e;padding:0.75rem 1rem;border-radius:8px;margin:1rem 0;}
    .info-banner a{font-weight:700;color:#92400e;margin-left:0.5rem;text-decoration:underline;cursor:pointer;}

    @media (max-width:768px){ .navbar{flex-direction:column;gap:1rem;} .navbar-right{flex-direction:column;gap:1rem;width:100%;} .header{flex-direction:column;align-items:flex-start;} table{font-size:0.85rem;} .btn{padding:0.4rem 0.6rem;font-size:0.8rem;} }
  </style>
</head>
<body>
  <div class="navbar">
    <div class="navbar-brand">üëë TRADEERA ADMIN</div>
    <div class="navbar-right">
      <div class="user-info"><span id="adminName">Admin</span></div>
      <button class="logout-btn" id="logoutBtn">üö™ Logout</button>
    </div>
  </div>

  <div class="container">
    <div id="infoBanner" class="info-banner" role="status" aria-live="polite"></div>

    <div class="header"><h1>User Management</h1></div>

    <div class="stats-grid">
      <div class="stat-card"><h3>Total Users</h3><div class="value" id="totalUsers">0</div></div>
      <div class="stat-card"><h3>Activated</h3><div class="value" id="activatedUsers">0</div></div>
      <div class="stat-card"><h3>Inactive</h3><div class="value" id="inactiveUsers">0</div></div>
      <div class="stat-card"><h3>Activation Wallets</h3><div class="value" id="totalActivationWallet">$0</div></div>
      <div class="stat-card"><h3>Matching Wallets</h3><div class="value" id="totalMatchingWallet">$0</div></div>
      <div class="stat-card"><h3>Total Income</h3><div class="value" id="totalIncome">$0</div></div>
    </div>

    <div class="table-container">
      <div class="table-header">
        <h2>Users</h2>
        <div class="search-box">
          <input type="text" id="searchInput" placeholder="Search username..." onkeyup="filterTable()">
        </div>
      </div>

      <div id="loading" class="loading"><div class="spinner"></div>Loading users...</div>

      <div class="table-wrapper">
        <table id="usersTable" style="display:none;">
          <thead>
            <tr>
              <th>User ID</th><th>Username</th><th>Email</th><th>Activation</th><th>Activation $</th><th>Matching $</th><th>Total $</th><th>Directs</th><th>Actions</th>
            </tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>

      <div id="emptyState" class="empty-state" style="display:none;">
        <i class="fas fa-inbox"></i>
        <p>No users found</p>
      </div>
    </div>
  </div>

  <div id="userModal" class="modal" aria-hidden="true">
    <div class="modal-content">
      <div class="modal-header">
        <h2>User Details</h2>
        <button class="close-btn" onclick="closeModal()">√ó</button>
      </div>
      <div id="modalBody"></div>
    </div>
  </div>

<script>
  const API_URL = window.location.origin;
  // If your server uses another endpoint to return current user, change this:
  const AUTH_CHECK_URL = `${API_URL}/api/auth/me`; // <-- change if your backend uses different route
  let allUsers = [];

  function showBanner(msg, includeLogin = false) {
    const el = document.getElementById('infoBanner');
    el.innerHTML = msg + (includeLogin ? ` <a id="goLogin">Go to login</a>` : '');
    el.style.display = 'block';
    if (includeLogin) {
      const link = document.getElementById('goLogin');
      link.addEventListener('click', () => { window.location.href = '/login'; });
    }
  }
  function hideBanner() {
    const el = document.getElementById('infoBanner');
    el.style.display = 'none';
    el.innerHTML = '';
  }

  async function serverAuthCheck() {
    // Try server-side verification of current session / cookie / token.
    try {
      const res = await fetch(AUTH_CHECK_URL, {
        method: 'GET',
        credentials: 'include',
        headers: { 'Cache-Control': 'no-cache' }
      });

      if (res.status === 200) {
        const data = await res.json();
        // expect something like { success: true, user: { username: 'admin', is_admin: true, ... } }
        if (data && (data.user || data.data)) {
          // support two common response shapes
          const userObj = data.user || data.data || data;
          const isAdmin = (userObj.is_admin === true) || (userObj.role === 'admin') || (userObj.isAdmin === true);
          if (isAdmin) {
            // set sessionStorage so existing client logic works
            sessionStorage.setItem('is_admin', 'true');
            sessionStorage.setItem('username', userObj.username || userObj.name || 'Admin');
            document.getElementById('adminName').textContent = sessionStorage.getItem('username');
            hideBanner();
            return true;
          } else {
            // user logged in but not admin
            console.warn('Authenticated user is not admin according to server response.', userObj);
            showBanner('You are authenticated but not an admin. Contact support.', false);
            return false;
          }
        } else {
          console.warn('Auth check returned 200 but unexpected body', data);
          showBanner('Unable to verify user. Please log in.', true);
          return false;
        }
      } else if (res.status === 401 || res.status === 403) {
        console.warn('Server indicated unauthenticated (401/403).');
        showBanner('You are not authenticated as an admin. Please log in.', true);
        return false;
      } else {
        console.warn('Unexpected response from auth check:', res.status);
        showBanner('Auth check returned an unexpected response. See console.', true);
        return false;
      }
    } catch (err) {
      console.error('Auth check failed:', err);
      showBanner('Auth check failed (network). Please check console and your server.', true);
      return false;
    }
  }

  async function doLogout() {
    try {
      await fetch(`${API_URL}/api/auth/logout`, { method: 'POST', credentials: 'include', headers: { 'Content-Type': 'application/json' } });
    } catch (err) {
      console.warn('Logout request error (ignored):', err);
    } finally {
      sessionStorage.removeItem('user_id');
      sessionStorage.removeItem('username');
      sessionStorage.removeItem('is_admin');
      localStorage.clear();
      window.location.href = '/login';
    }
  }

  async function loadUsers() {
    try {
      document.getElementById('loading').style.display = 'block';
      const response = await fetch(`${API_URL}/api/admin/users`, { credentials: 'include', headers: { 'Cache-Control': 'no-cache' } });
      if (response.status === 401 || response.status === 403) { showBanner('Session expired or unauthorized. Please log in again.', true); document.getElementById('loading').style.display='none'; return; }
      const data = await response.json();
      if (data && data.success) {
        allUsers = data.users || [];
        renderTable();
      } else {
        allUsers = (data && data.users) ? data.users : [];
        renderTable();
      }
    } catch (err) { console.error('Error loading users:', err); showBanner('Error loading users. See console.'); }
    finally { document.getElementById('loading').style.display = 'none'; }
  }

  async function loadStats() {
    try {
      const response = await fetch(`${API_URL}/api/admin/stats`, { credentials: 'include', headers: { 'Cache-Control': 'no-cache' } });
      if (response.status === 401 || response.status === 403) { showBanner('Session expired or unauthorized. Please log in again.', true); return; }
      const data = await response.json();
      if (data && data.success) {
        const stats = data.stats || {};
        document.getElementById('totalUsers').textContent = stats.total_users || 0;
        document.getElementById('activatedUsers').textContent = stats.activated_users || 0;
        document.getElementById('inactiveUsers').textContent = stats.inactive_users || 0;
        document.getElementById('totalActivationWallet').textContent = '$' + ((stats.total_activation_wallet || 0).toFixed(2));
        document.getElementById('totalMatchingWallet').textContent = '$' + ((stats.total_matching_wallet || 0).toFixed(2));
        document.getElementById('totalIncome').textContent = '$' + (((stats.total_activation_wallet || 0) + (stats.total_matching_wallet || 0)).toFixed(2));
      }
    } catch (err) { console.error('Error loading stats:', err); showBanner('Error loading stats. See console.'); }
  }

  function renderTable() {
    const tbody = document.getElementById('tableBody');
    tbody.innerHTML = '';
    if (!allUsers || allUsers.length === 0) {
      document.getElementById('usersTable').style.display = 'none';
      document.getElementById('emptyState').style.display = 'block';
      return;
    }
    document.getElementById('usersTable').style.display = 'table';
    document.getElementById('emptyState').style.display = 'none';
    allUsers.forEach(user => {
      const activationStatus = user.activation_status === 'active' ? 'status-active' : 'status-inactive';
      const activationText = user.activation_status === 'active' ? '‚úÖ Active' : '‚ùå Inactive';
      const visibleId = (user.user_id || '').substring(0,12);
      const row = document.createElement('tr');
      row.innerHTML = `
        <td><div class="user-id" title="${user.user_id || ''}">${visibleId}${(user.user_id && user.user_id.length > 12) ? '...' : ''}</div></td>
        <td><strong>${user.username || ''}</strong></td>
        <td>${user.email || ''}</td>
        <td><span class="status-badge ${activationStatus}">${activationText}</span></td>
        <td class="amount">$${((user.activation_wallet || 0)).toFixed(2)}</td>
        <td class="amount">$${((user.matching_wallet || 0)).toFixed(2)}</td>
        <td class="amount">$${((user.total_income || 0)).toFixed(2)}</td>
        <td>${user.directs || 0}</td>
        <td>
          <div class="actions">
            <button class="btn btn-activate-100" onclick="activateUser('${user.user_id}', 100)">$100</button>
            <button class="btn btn-activate-free" onclick="activateUser('${user.user_id}', 0)">FREE</button>
            <button class="btn btn-view" onclick="viewUserDetails('${user.user_id}')">View</button>
          </div>
        </td>
      `;
      tbody.appendChild(row);
    });
  }

  function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(()=>{ alert('‚úÖ User ID copied!'); }).catch(err=>{ console.error('Clipboard error',err); alert('Could not copy'); });
  }

  async function activateUser(userId, cost) {
    if (!confirm(`Activate user with $${cost} cost?`)) return;
    try {
      const response = await fetch(`${API_URL}/api/admin/user/${userId}/activate`, {
        method: 'PUT',
        headers: {'Content-Type':'application/json'},
        credentials: 'include',
        body: JSON.stringify({ action: 'activate', cost: cost })
      });
      if (response.status === 401 || response.status === 403) { showBanner('Unauthorized. Please log in again.', true); return; }
      const data = await response.json();
      if (data && data.success) {
        alert(`‚úÖ ${data.message}`);
        await loadUsers();
      } else alert(`‚ùå ${data && data.message ? data.message : 'Unknown error'}`);
    } catch (err) { alert('Error: ' + (err.message || err)); }
  }

  function viewUserDetails(userId) {
    const user = allUsers.find(u => u.user_id === userId);
    if (!user) return;
    const modalBody = document.getElementById('modalBody');
    const walletBalance = user.wallet_balance || 0;
    modalBody.innerHTML = `
      <div class="user-detail"><label>User ID</label><p>${user.user_id || ''} <button class="btn btn-copy" onclick="copyToClipboard('${user.user_id || ''}')">üìã Copy</button></p></div>
      <div class="user-detail"><label>Username</label><p>${user.username || ''}</p></div>
      <div class="user-detail"><label>Email</label><p>${user.email || ''}</p></div>
      <div class="user-detail"><label>Name</label><p>${user.name || ''}</p></div>
      <div class="user-detail"><label>Activation Status</label><p><span class="status-badge ${user.activation_status === 'active' ? 'status-active' : 'status-inactive'}">${user.activation_status === 'active' ? '‚úÖ Active' : '‚ùå Inactive'}</span></p></div>
      <div class="user-detail"><label>Main Wallet Balance</label><p class="amount">$${walletBalance.toFixed(2)}</p></div>
      <div class="user-detail"><label>Activation Wallet</label><p class="amount">$${(user.activation_wallet || 0).toFixed(2)}</p></div>
      <div class="user-detail"><label>Matching Wallet</label><p class="amount">$${(user.matching_wallet || 0).toFixed(2)}</p></div>
      <div class="user-detail"><label>Total Income</label><p class="amount">$${(user.total_income || 0).toFixed(2)}</p></div>
      <div class="user-detail"><label>Direct Members</label><p>${user.directs || 0}</p></div>
      <div class="user-detail"><label>Created At</label><p>${user.created_at ? new Date(user.created_at).toLocaleString() : 'N/A'}</p></div>
      <div style="margin-top:2rem;display:flex;gap:1rem;flex-wrap:wrap;">
        <button class="btn btn-activate-100" onclick="activateUser('${user.user_id}', 100)">Activate $100</button>
        <button class="btn btn-activate-free" onclick="activateUser('${user.user_id}', 0)">Activate FREE</button>
        <button class="btn btn-view" onclick="closeModal()">Close</button>
      </div>
    `;
    document.getElementById('userModal').classList.add('active');
    document.getElementById('userModal').setAttribute('aria-hidden','false');
  }

  function closeModal() { document.getElementById('userModal').classList.remove('active'); document.getElementById('userModal').setAttribute('aria-hidden','true'); }

  function filterTable() {
    const searchText = document.getElementById('searchInput').value.toLowerCase();
    const tbody = document.getElementById('tableBody');
    const rows = tbody.getElementsByTagName('tr');
    for (let row of rows) {
      const username = row.cells[1] && row.cells[1].textContent ? row.cells[1].textContent.toLowerCase() : '';
      row.style.display = username.includes(searchText) ? '' : 'none';
    }
  }

  // Initialization: server-auth-check -> then load data
  window.addEventListener('load', async function() {
    console.log('‚úÖ Admin panel load event fired');
    // 1) Try server-side auth check (this won't create redirect loops)
    const ok = await serverAuthCheck();
    if (!ok) {
      console.log('Initialization stopped because user is not authenticated as admin.');
      // attach logout click anyway to allow manual navigation
      document.getElementById('logoutBtn').addEventListener('click', doLogout);
      return;
    }
    // 2) If server says admin, proceed
    document.getElementById('logoutBtn').addEventListener('click', doLogout);
    await loadUsers();
    await loadStats();
    console.log('‚úÖ Admin panel initialized. Data loaded ONCE. No auto-refresh.');
  });
</script>
</body>
</html>
