<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel - TRADEERA</title>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    /* (kept your full original CSS unchanged) */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Nunito', sans-serif;
      background: #f8fafc;
      color: #1f2937;
    }
    /* ... rest of your CSS ... (omitted here to save space but in the file keep it exactly) */
  </style>
</head>
<body>

<div class="navbar">
  <div class="navbar-brand">üëë TRADEERA ADMIN</div>
  <div class="navbar-right">
    <div class="user-info">
      <span id="adminName">Admin</span>
    </div>
    <button class="logout-btn" id="logoutBtn">üö™ Logout</button>
  </div>
</div>

<div class="container">
  <div class="header">
    <h1>User Management</h1>
  </div>

  <div class="stats-grid">
    <div class="stat-card">
      <h3>Total Users</h3>
      <div class="value" id="totalUsers">0</div>
    </div>
    <div class="stat-card">
      <h3>Activated</h3>
      <div class="value" id="activatedUsers">0</div>
    </div>
    <div class="stat-card">
      <h3>Inactive</h3>
      <div class="value" id="inactiveUsers">0</div>
    </div>
    <div class="stat-card">
      <h3>Activation Wallets</h3>
      <div class="value" id="totalActivationWallet">$0</div>
    </div>
    <div class="stat-card">
      <h3>Matching Wallets</h3>
      <div class="value" id="totalMatchingWallet">$0</div>
    </div>
    <div class="stat-card">
      <h3>Total Income</h3>
      <div class="value" id="totalIncome">$0</div>
    </div>
  </div>

  <div class="table-container">
    <div class="table-header">
      <h2>Users</h2>
      <div class="search-box">
        <input type="text" id="searchInput" placeholder="Search username..." onkeyup="filterTable()">
      </div>
    </div>

    <div id="loading" class="loading">
      <div class="spinner"></div>
      Loading users...
    </div>

    <div class="table-wrapper">
      <table id="usersTable" style="display: none;">
        <thead>
          <tr>
            <th>User ID</th>
            <th>Username</th>
            <th>Email</th>
            <th>Activation</th>
            <th>Activation $</th>
            <th>Matching $</th>
            <th>Total $</th>
            <th>Directs</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>

    <div id="emptyState" class="empty-state">
      <i class="fas fa-inbox"></i>
      <p>No users found</p>
    </div>
  </div>
</div>

<div id="userModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>User Details</h2>
      <button class="close-btn" onclick="closeModal()">√ó</button>
    </div>
    <div id="modalBody"></div>
  </div>
</div>

<script>
  const API_URL = window.location.origin;
  let allUsers = [];

  /* -----------------------------
     Minimal, robust server auth check
     - tries multiple common endpoints
     - if all endpoints return 404, we don't block initialization
     - if 401/403 is returned we show warning and don't repeatedly redirect
     ----------------------------- */
  const AUTH_ENDPOINTS = [
    '/api/auth/me',
    '/api/auth/profile',
    '/api/admin/me',
    '/api/auth/user'
  ];

  async function serverAuthCheckOnce() {
    // Try each common endpoint until one returns 200 or a meaningful 401/403.
    for (let path of AUTH_ENDPOINTS) {
      const url = API_URL + path;
      try {
        const res = await fetch(url, { method: 'GET', credentials: 'include', headers: { 'Cache-Control': 'no-cache' }});
        if (res.status === 200) {
          // Good ‚Äî parse and verify admin property
          const data = await res.json();
          const userObj = (data && (data.user || data.data || data)) ? (data.user || data.data || data) : null;
          if (userObj) {
            const isAdmin = (userObj.is_admin === true) || (userObj.role === 'admin') || (userObj.isAdmin === true) || (userObj.role === 'administrator');
            if (isAdmin) {
              sessionStorage.setItem('is_admin', 'true');
              sessionStorage.setItem('username', userObj.username || userObj.name || 'Admin');
              document.getElementById('adminName').textContent = sessionStorage.getItem('username') || 'Admin';
              console.log('serverAuthCheckOnce: server confirmed admin via', path);
              return { ok: true };
            } else {
              console.warn('serverAuthCheckOnce: authenticated but not admin via', path);
              return { ok: false, reason: 'not_admin' };
            }
          } else {
            console.warn('serverAuthCheckOnce: 200 but unexpected body from', path, data);
            return { ok: false, reason: 'bad_body' };
          }
        } else if (res.status === 401 || res.status === 403) {
          console.warn('serverAuthCheckOnce: unauthorized from', path, res.status);
          return { ok: false, reason: 'unauthorized', status: res.status };
        } else if (res.status === 404) {
          // try next endpoint
          console.log('serverAuthCheckOnce: endpoint', path, 'returned 404 ‚Äî trying next');
          continue;
        } else {
          console.warn('serverAuthCheckOnce: endpoint', path, 'returned status', res.status);
          return { ok: false, reason: 'unexpected_status', status: res.status };
        }
      } catch (err) {
        console.error('serverAuthCheckOnce: network/error calling', path, err);
        // keep trying remaining endpoints
        continue;
      }
    }

    // If we reach here: all endpoints either 404 or failed to respond.
    console.warn('serverAuthCheckOnce: no auth endpoint found (all returned 404 or failed). Will not block initialization.');
    return { ok: null, reason: 'no_endpoint' };
  }

  // Logout (unchanged)
  function doLogout() {
    console.log("üö™ Logout initiated");
    
    fetch(`${API_URL}/api/auth/logout`, {
      method: 'POST',
      credentials: 'include',
      headers: { 'Content-Type': 'application/json' }
    })
    .then(res => {
      console.log("‚úÖ Logout API called");
      sessionStorage.removeItem('user_id');
      sessionStorage.removeItem('username');
      sessionStorage.removeItem('is_admin');
      localStorage.clear();
      
      setTimeout(() => {
        window.location.href = '/login';
      }, 100);
    })
    .catch(err => {
      console.error("‚ùå Logout error:", err);
      sessionStorage.removeItem('user_id');
      sessionStorage.removeItem('username');
      sessionStorage.removeItem('is_admin');
      localStorage.clear();
      
      window.location.href = '/login';
    });
  }

  // Check auth (minimal edit)
  async function checkAuth() {
    try {
      if (sessionStorage.getItem('is_admin') && sessionStorage.getItem('is_admin') === 'true') {
        document.getElementById('adminName').textContent = sessionStorage.getItem('username') || 'Admin';
        return true;
      }

      // if sessionStorage absent try server endpoints once
      console.log('User not marked admin in sessionStorage ‚Äî attempting server auth check once.');
      const result = await serverAuthCheckOnce();

      // result.ok = true  -> server confirmed admin
      // result.ok = false -> server responded but not admin/unauthorized
      // result.ok = null  -> no endpoints found (404) -> let init continue (do not redirect)
      if (result.ok === true) {
        return true;
      } else if (result.ok === false) {
        // server says unauthorized or not admin -> redirect to /login only if not on login page
        if (result.reason === 'unauthorized' || result.reason === 'not_admin') {
          console.warn('Auth check failed:', result);
          if (!window.location.pathname.includes('/login')) {
            // safe single redirect (replace to avoid history loop)
            window.location.replace('/login');
          }
          return false;
        }
        // other reasons ‚Äî treat as not authed and redirect
        if (!window.location.pathname.includes('/login')) {
          window.location.replace('/login');
        }
        return false;
      } else {
        // result.ok === null (no endpoint found). This is the key safe path:
        // allow initialization to continue (prevents reload/redirect loop).
        console.log('No auth endpoints found. Continuing initialization (server has no /api/auth/me).');
        return true; // allow init to continue; subsequent API calls will show 401 if actually unauthorized
      }
    } catch (err) {
      console.error('checkAuth error:', err);
      if (!window.location.pathname.includes('/login')) {
        window.location.replace('/login');
      }
      return false;
    }
  }

  // Load users - ONCE ONLY (unchanged)
  async function loadUsers() {
    try {
      document.getElementById('loading').style.display = 'block';
      const response = await fetch(`${API_URL}/api/admin/users`, {
        credentials: 'include',
        headers: { 'Cache-Control': 'no-cache, no-store, must-revalidate' }
      });
      const data = await response.json();

      if (data.success) {
        allUsers = data.users;
        renderTable();
      }
    } catch (error) {
      console.error('Error loading users:', error);
    } finally {
      document.getElementById('loading').style.display = 'none';
    }
  }

  // Load stats - ONCE ONLY (unchanged)
  async function loadStats() {
    try {
      const response = await fetch(`${API_URL}/api/admin/stats`, {
        credentials: 'include',
        headers: { 'Cache-Control': 'no-cache, no-store, must-revalidate' }
      });
      const data = await response.json();

      if (data.success) {
        const stats = data.stats;
        document.getElementById('totalUsers').textContent = stats.total_users;
        document.getElementById('activatedUsers').textContent = stats.activated_users;
        document.getElementById('inactiveUsers').textContent = stats.inactive_users;
        document.getElementById('totalActivationWallet').textContent = '$' + stats.total_activation_wallet.toFixed(2);
        document.getElementById('totalMatchingWallet').textContent = '$' + stats.total_matching_wallet.toFixed(2);
        document.getElementById('totalIncome').textContent = '$' + (stats.total_activation_wallet + stats.total_matching_wallet).toFixed(2);
      }
    } catch (error) {
      console.error('Error loading stats:', error);
    }
  }

  // Render table (unchanged)
  function renderTable() {
    const tbody = document.getElementById('tableBody');
    tbody.innerHTML = '';

    if (allUsers.length === 0) {
      document.getElementById('usersTable').style.display = 'none';
      document.getElementById('emptyState').style.display = 'block';
      return;
    }

    document.getElementById('usersTable').style.display = 'table';
    document.getElementById('emptyState').style.display = 'none';

    allUsers.forEach(user => {
      const activationStatus = user.activation_status === 'active' ? 'status-active' : 'status-inactive';
      const activationText = user.activation_status === 'active' ? '‚úÖ Active' : '‚ùå Inactive';

      const row = document.createElement('tr');
      row.innerHTML = `
        <td><div class="user-id" title="${user.user_id}">${user.user_id.substring(0, 12)}...</div></td>
        <td><strong>${user.username}</strong></td>
        <td>${user.email}</td>
        <td><span class="status-badge ${activationStatus}">${activationText}</span></td>
        <td class="amount">$${(user.activation_wallet || 0).toFixed(2)}</td>
        <td class="amount">$${(user.matching_wallet || 0).toFixed(2)}</td>
        <td class="amount">$${(user.total_income || 0).toFixed(2)}</td>
        <td>${user.directs}</td>
        <td>
          <div class="actions">
            <button class="btn btn-activate-100" onclick="activateUser('${user.user_id}', 100)">$100</button>
            <button class="btn btn-activate-free" onclick="activateUser('${user.user_id}', 0)">FREE</button>
            <button class="btn btn-view" onclick="viewUserDetails('${user.user_id}')">View</button>
          </div>
        </td>
      `;
      tbody.appendChild(row);
    });
  }

  // Copy, activate, view, close, filter (unchanged)...
  function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
      alert('‚úÖ User ID copied!');
    });
  }

  async function activateUser(userId, cost) {
    if (!confirm(`Activate user with $${cost} cost?`)) return;

    try {
      const response = await fetch(`${API_URL}/api/admin/user/${userId}/activate`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ action: 'activate', cost: cost })
      });

      const data = await response.json();

      if (data.success) {
        alert(`‚úÖ ${data.message}`);
      } else {
        alert(`‚ùå ${data.message}`);
      }
    } catch (error) {
      alert('Error: ' + error.message);
    }
  }

  function viewUserDetails(userId) {
    const user = allUsers.find(u => u.user_id === userId);
    if (!user) return;

    const modalBody = document.getElementById('modalBody');
    const walletBalance = user.wallet_balance || 0;

    modalBody.innerHTML = `
      <div class="user-detail">
        <label>User ID</label>
        <p>${user.user_id} <button class="btn btn-copy" onclick="copyToClipboard('${user.user_id}')">üìã Copy</button></p>
      </div>
      <div class="user-detail">
        <label>Username</label>
        <p>${user.username}</p>
      </div>
      <div class="user-detail">
        <label>Email</label>
        <p>${user.email}</p>
      </div>
      <div class="user-detail">
        <label>Name</label>
        <p>${user.name}</p>
      </div>
      <div class="user-detail">
        <label>Activation Status</label>
        <p><span class="status-badge ${user.activation_status === 'active' ? 'status-active' : 'status-inactive'}">${user.activation_status === 'active' ? '‚úÖ Active' : '‚ùå Inactive'}</span></p>
      </div>
      <div class="user-detail">
        <label>Main Wallet Balance</label>
        <p class="amount">$${walletBalance.toFixed(2)}</p>
      </div>
      <div class="user-detail">
        <label>Activation Wallet</label>
        <p class="amount">$${(user.activation_wallet || 0).toFixed(2)}</p>
      </div>
      <div class="user-detail">
        <label>Matching Wallet</label>
        <p class="amount">$${(user.matching_wallet || 0).toFixed(2)}</p>
      </div>
      <div class="user-detail">
        <label>Total Income</label>
        <p class="amount">$${(user.total_income || 0).toFixed(2)}</p>
      </div>
      <div class="user-detail">
        <label>Direct Members</label>
        <p>${user.directs}</p>
      </div>
      <div class="user-detail">
        <label>Created At</label>
        <p>${new Date(user.created_at).toLocaleString()}</p>
      </div>
      <div style="margin-top: 2rem; display: flex; gap: 1rem; flex-wrap: wrap;">
        <button class="btn btn-activate-100" onclick="activateUser('${user.user_id}', 100)">Activate $100</button>
        <button class="btn btn-activate-free" onclick="activateUser('${user.user_id}', 0)">Activate FREE</button>
        <button class="btn btn-view" onclick="closeModal()">Close</button>
      </div>
    `;

    document.getElementById('userModal').classList.add('active');
  }

  function closeModal() {
    document.getElementById('userModal').classList.remove('active');
  }

  function filterTable() {
    const searchText = document.getElementById('searchInput').value.toLowerCase();
    const tbody = document.getElementById('tableBody');
    const rows = tbody.getElementsByTagName('tr');

    for (let row of rows) {
      const username = row.cells[1].textContent.toLowerCase();
      row.style.display = username.includes(searchText) ? '' : 'none';
    }
  }

  // Initialize - Load data ONCE when page opens
  window.addEventListener('load', async function() {
    console.log("‚úÖ Admin panel load event fired");
    const authed = await checkAuth(); // now handles missing /api/auth/me gracefully
    if (!authed) {
      console.log('Initialization stopped because user is not authenticated as admin.');
      return;
    }
    loadUsers();
    loadStats();
    
    document.getElementById('logoutBtn').addEventListener('click', doLogout);
    
    console.log("‚úÖ Admin panel initialized. Data loaded ONCE. No auto-refresh.");
  });
</script>

</body>
</html>
